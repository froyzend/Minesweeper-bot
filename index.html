<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Minesweeper</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        user-select: none; /* Отключает выделение текста на всей странице */
      }

      #gameBoard {
        display: grid;
        grid-template-columns: repeat(9, 40px);
        grid-template-rows: repeat(15, 40px);
        gap: 1px;
        margin: 20px auto;
      }

      .cell {
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #e0e0e0;
        border: 1px solid #aaa;
        cursor: pointer;
        font-size: 20px;
        -webkit-user-select: none; /* Отключает выделение текста на ячейках */
        -moz-user-select: none; /* Отключает выделение текста на ячейках для Firefox */
        -ms-user-select: none; /* Отключает выделение текста на ячейках для IE */
        user-select: none; /* Отключает выделение текста на ячейках */
      }

      .cell.revealed {
        background-color: #f0f0f0;
      }

      .cell.mine {
        background-color: red;
      }

      .cell.flag {
        background-color: yellow;
      }

      #timer {
        font-size: 20px;
      }

      #restartBtn {
        display: none;
        margin-top: 20px;
      }

      #statusMessage {
        font-size: 20px;
        margin-top: 20px;
        color: green;
      }

      .game-over {
        color: red;
      }

      .game-won {
        color: green;
      }
    </style>
  </head>
  <body>
    <h1>Minesweeper</h1>
    <div id="gameBoard"></div>
    <button id="restartBtn">Перезапустить игру</button>
    <div id="timer">Время: 0</div>
    <div id="statusMessage"></div>
    <script src="index.js"></script>
    <script>
      const rows = 15; // 15 ячеек по вертикали
      const cols = 9; // 9 ячеек по горизонтали
      const totalMines = 16; // 16 мин
      let board = [];
      let revealedCount = 0;
      let timerInterval;
      let seconds = 0;

      function createBoard() {
        board = Array.from({ length: rows }, () => Array(cols).fill(0));

        // Расставляем мины
        let minesPlaced = 0;
        while (minesPlaced < totalMines) {
          const row = Math.floor(Math.random() * rows);
          const col = Math.floor(Math.random() * cols);

          if (board[row][col] !== "X") {
            board[row][col] = "X";
            minesPlaced++;
            // Увеличиваем счетчик мин вокруг
            for (let r = row - 1; r <= row + 1; r++) {
              for (let c = col - 1; c <= col + 1; c++) {
                if (
                  r >= 0 &&
                  r < rows &&
                  c >= 0 &&
                  c < cols &&
                  board[r][c] !== "X"
                ) {
                  board[r][c]++;
                }
              }
            }
          }
        }
      }

      function createGameBoard() {
        const gameBoard = document.getElementById("gameBoard");
        gameBoard.innerHTML = "";

        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            const cell = document.createElement("div");
            cell.className = "cell";
            cell.dataset.row = r;
            cell.dataset.col = c;

            cell.addEventListener("click", () => {
              if (!cell.classList.contains("revealed")) {
                revealCell(cell);
              }
            });

            // Долгое нажатие для установки флага
            cell.addEventListener("contextmenu", (e) => {
              e.preventDefault();
              toggleFlag(cell);
            });

            gameBoard.appendChild(cell);

            // Обработка длительного нажатия
            let pressTimer;
            cell.addEventListener("touchstart", () => {
              pressTimer = setTimeout(() => {
                toggleFlag(cell);
              }, 500); // 500 мс для длительного нажатия
            });

            cell.addEventListener("touchend", () => {
              clearTimeout(pressTimer);
            });
          }
        }
      }

      function revealCell(cell) {
        const row = parseInt(cell.dataset.row);
        const col = parseInt(cell.dataset.col);

        if (board[row][col] === "X") {
          cell.classList.add("mine");
          gameOver(false);
        } else if (!cell.classList.contains("revealed")) {
          cell.classList.add("revealed");
          revealedCount++;
          const mineCount = board[row][col];
          if (mineCount > 0) {
            cell.textContent = mineCount;
          } else {
            // Если вокруг нет мин, открываем соседние клетки
            for (let r = row - 1; r <= row + 1; r++) {
              for (let c = col - 1; c <= col + 1; c++) {
                if (r >= 0 && r < rows && c >= 0 && c < cols) {
                  const neighbor = document.querySelector(
                    `.cell[data-row="${r}"][data-col="${c}"]`
                  );
                  if (neighbor && !neighbor.classList.contains("revealed")) {
                    revealCell(neighbor);
                  }
                }
              }
            }
          }
        }
        checkVictory();
      }

      function toggleFlag(cell) {
        if (!cell.classList.contains("revealed")) {
          cell.classList.toggle("flag");
        }
      }

      function gameOver(won) {
        clearInterval(timerInterval);
        const cells = document.querySelectorAll(".cell");
        cells.forEach((cell) => {
          if (
            cell.classList.contains("flag") &&
            board[cell.dataset.row][cell.dataset.col] !== "X"
          ) {
            cell.classList.add("mine");
          }
          cell.removeEventListener("click", () => revealCell(cell));
        });

        const statusMessage = document.getElementById("statusMessage");
        if (won) {
          statusMessage.textContent = "Вы выиграли!";
          statusMessage.className = "game-won";
        } else {
          statusMessage.textContent = "Игра окончена! Вы попали на мину!";
          statusMessage.className = "game-over";
        }

        document.getElementById("restartBtn").style.display = "block";
      }

      function checkVictory() {
        if (revealedCount === rows * cols - totalMines) {
          gameOver(true);
        }
      }

      function startTimer() {
        seconds = 0;
        document.getElementById("timer").textContent = "Время: 0";
        timerInterval = setInterval(() => {
          seconds++;
          document.getElementById("timer").textContent = `Время: ${seconds}`;
        }, 1000);
      }

      function restartGame() {
        createBoard();
        createGameBoard();
        revealedCount = 0;
        clearInterval(timerInterval);
        startTimer(); // Запускаем таймер
        document.getElementById("statusMessage").textContent = ""; // Очищаем сообщение
        document.getElementById("restartBtn").style.display = "none";
      }

      document
        .getElementById("restartBtn")
        .addEventListener("click", restartGame);

      // Запускаем игру при загрузке страницы
      restartGame(); // Здесь запускается игра
    </script>
  </body>
</html>
